# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Rebuild on Contentful publish
on:
  repository_dispatch:
    types: [contentful.publish]

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn
      - run: corepack enable
      - run: yarn install --frozen-lockfile
      - run: yarn sync:contentful
        env:
          CONTENTFUL_SPACE_ID: ${{ secrets.CONTENTFUL_SPACE_ID }}
          CONTENTFUL_ENVIRONMENT: ${{ secrets.CONTENTFUL_ENVIRONMENT }}
          CONTENTFUL_DELIVERY_TOKEN: ${{ secrets.CONTENTFUL_DELIVERY_TOKEN }}
      - run: yarn build
      - uses: actions/upload-pages-artifact@v3
        with: { path: build }
      - id: deployment
        uses: actions/deploy-pages@v4
